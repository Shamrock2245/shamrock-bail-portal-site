<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Shamrock Mobile</title>
    
    <!-- Server-side data injection -->
    <div id="server-data-injection" style="display:none;"
        data-json='<?!= (typeof data !== "undefined") ? JSON.stringify(data) : "null" ?>'></div>
    <script>
        (function () {
            var dataDiv = document.getElementById('server-data-injection');
            window.INJECTED_DATA = JSON.parse(dataDiv.getAttribute('data-json') || 'null');
        })();
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================================
           MOBILE DASHBOARD - iPhone Optimized
           Single column, large touch targets, swipeable sections
           ========================================================= */
        :root {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --surface-2: #f8f9fc;
            --text: #0f172a;
            --text-secondary: #64748b;
            --muted: #94a3b8;
            --border: rgba(0, 0, 0, 0.06);
            --brand: #0f172a;
            --accent: #d4af37;
            --accent-light: rgba(212, 175, 55, 0.15);
            --success: #10b981;
            --success-light: rgba(16, 185, 129, 0.15);
            --error: #ef4444;
            --error-light: rgba(239, 68, 68, 0.15);
            --warning: #f59e0b;
            --radius: 20px;
            --radius-sm: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            padding-top: var(--safe-top);
            padding-bottom: calc(80px + var(--safe-bottom));
        }

        /* =========================================================
           HEADER - Compact Mobile Header
           ========================================================= */
        .header {
            background: linear-gradient(135deg, var(--brand) 0%, #1e293b 100%);
            color: white;
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
        }

        /* =========================================================
           TAB NAVIGATION - Swipeable Tabs
           ========================================================= */
        .tab-nav {
            display: flex;
            background: var(--surface);
            padding: 8px;
            margin: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-btn .tab-icon {
            font-size: 20px;
        }

        .tab-btn.active {
            background: var(--brand);
            color: white;
        }

        .tab-btn:active {
            transform: scale(0.95);
        }

        /* =========================================================
           CONTENT SECTIONS
           ========================================================= */
        .section {
            display: none;
            padding: 0 16px 16px;
        }

        .section.active {
            display: block;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* =========================================================
           FORM ELEMENTS - Large Touch Targets
           ========================================================= */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group label.required::after {
            content: " *";
            color: var(--error);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface-2);
            color: var(--text);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--surface);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 20px;
            padding-right: 48px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        /* =========================================================
           QUICK INFO DISPLAY
           ========================================================= */
        .quick-info {
            background: var(--accent-light);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 16px;
        }

        .quick-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .quick-info-row:last-child {
            border-bottom: none;
        }

        .quick-info-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .quick-info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        /* =========================================================
           CHARGES LIST
           ========================================================= */
        .charge-item {
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .charge-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .charge-desc-input {
            flex: 1;
            margin-right: 12px;
        }

        .charge-remove {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--error-light);
            color: var(--error);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
        }

        .charge-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .add-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-light);
            border: 2px dashed var(--accent);
            border-radius: var(--radius-sm);
            color: var(--brand);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-btn:active {
            background: var(--accent);
        }

        /* =========================================================
           INDEMNITOR CARDS
           ========================================================= */
        .indemnitor-item {
            background: var(--surface-2);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--success);
        }

        .indemnitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .indemnitor-header h3 {
            font-size: 15px;
            font-weight: 700;
        }

        .indemnitor-remove {
            padding: 8px 16px;
            background: var(--error-light);
            color: var(--error);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* =========================================================
           PAYMENT SECTION
           ========================================================= */
        .payment-summary-card {
            background: linear-gradient(135deg, var(--brand) 0%, #1e293b 100%);
            color: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-top: 20px;
        }

        .payment-summary-card h3 {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 16px;
        }

        .payment-line {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 15px;
        }

        .payment-line:last-child {
            border-bottom: none;
        }

        .payment-line.total {
            font-size: 20px;
            font-weight: 700;
            padding-top: 16px;
            margin-top: 8px;
            border-top: 2px solid var(--accent);
        }

        .payment-link-btn {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: var(--brand);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .payment-link-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* =========================================================
           BOTTOM ACTION BAR
           ========================================================= */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            display: flex;
            gap: 10px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .action-btn {
            flex: 1;
            padding: 16px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .action-btn .action-icon {
            font-size: 20px;
        }

        .action-btn.secondary {
            background: var(--surface-2);
            color: var(--text);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--brand);
        }

        .action-btn.success {
            background: var(--success);
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* =========================================================
           TOAST & LOADING
           ========================================================= */
        .toast {
            position: fixed;
            top: calc(80px + var(--safe-top));
            left: 16px;
            right: 16px;
            background: var(--brand);
            color: white;
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* =========================================================
           MODAL
           ========================================================= */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-end;
            z-index: 1500;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            width: 100%;
            max-height: 80vh;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--surface-2);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="logo">
                <span class="logo-icon">‚òòÔ∏è</span>
                <span>Shamrock</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="pasteFromClipboard()">üìã</button>
                <button class="icon-btn" onclick="showMenu()">‚ãÆ</button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('defendant')">
            <span class="tab-icon">üë§</span>
            <span>Defendant</span>
        </button>
        <button class="tab-btn" onclick="switchTab('indemnitor')">
            <span class="tab-icon">ü§ù</span>
            <span>Indemnitor</span>
        </button>
        <button class="tab-btn" onclick="switchTab('payment')">
            <span class="tab-icon">üí∞</span>
            <span>Payment</span>
        </button>
    </nav>

    <!-- SECTION: Defendant -->
    <section id="defendant-section" class="section active">
        <!-- Quick Info Summary -->
        <div class="quick-info" id="quick-summary" style="display: none;">
            <div class="quick-info-row">
                <span class="quick-info-label">Defendant</span>
                <span class="quick-info-value" id="summary-name">-</span>
            </div>
            <div class="quick-info-row">
                <span class="quick-info-label">County</span>
                <span class="quick-info-value" id="summary-county">-</span>
            </div>
            <div class="quick-info-row">
                <span class="quick-info-label">Total Bond</span>
                <span class="quick-info-value" id="summary-bond">$0.00</span>
            </div>
        </div>

        <!-- Personal Info Card -->
        <div class="card">
            <div class="card-header">
                <h2>üë§ Personal Info</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">First Name</label>
                        <input type="text" id="def-first" placeholder="John" oninput="updateSummary()">
                    </div>
                    <div class="form-group">
                        <label class="required">Last Name</label>
                        <input type="text" id="def-last" placeholder="Doe" oninput="updateSummary()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="required">Date of Birth</label>
                    <input type="date" id="def-dob">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="def-phone" placeholder="(239) 555-1234">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="def-email" placeholder="email@example.com">
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Info Card -->
        <div class="card">
            <div class="card-header">
                <h2>üèõÔ∏è Booking Info</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Booking #</label>
                        <input type="text" id="def-booking" placeholder="2024-123456">
                    </div>
                    <div class="form-group">
                        <label>County</label>
                        <select id="def-county" onchange="updateSummary()">
                            <option value="Lee">Lee</option>
                            <option value="Collier">Collier</option>
                            <option value="Charlotte">Charlotte</option>
                            <option value="Hendry">Hendry</option>
                            <option value="Glades">Glades</option>
                            <option value="Sarasota">Sarasota</option>
                            <option value="Manatee">Manatee</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Arrest Date</label>
                    <input type="date" id="def-arrest-date">
                </div>
            </div>
        </div>

        <!-- Charges Card -->
        <div class="card">
            <div class="card-header">
                <h2>‚öñÔ∏è Charges</h2>
                <button class="icon-btn" onclick="addCharge()" style="background: var(--accent-light); color: var(--brand);">+</button>
            </div>
            <div class="card-body">
                <div id="charges-list">
                    <div class="charge-item" data-id="1">
                        <div class="charge-item-header">
                            <input type="text" class="charge-desc" placeholder="Charge description" style="flex:1; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:15px;">
                            <button class="charge-remove" onclick="removeCharge(this)">√ó</button>
                        </div>
                        <div class="charge-details">
                            <div class="form-group" style="margin:0;">
                                <input type="text" class="charge-bond" placeholder="Bond $" onchange="calculatePayment()" style="padding:12px;">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <select class="charge-type" style="padding:12px;">
                                    <option value="M">Misdemeanor</option>
                                    <option value="F">Felony</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="add-btn" onclick="addCharge()">+ Add Another Charge</button>
            </div>
        </div>
    </section>

    <!-- SECTION: Indemnitor -->
    <section id="indemnitor-section" class="section">
        <div class="card">
            <div class="card-header">
                <h2>ü§ù Indemnitors</h2>
                <button class="icon-btn" onclick="addIndemnitor()" style="background: var(--success-light); color: var(--success);">+</button>
            </div>
            <div class="card-body">
                <div id="indemnitors-list">
                    <div class="indemnitor-item" data-id="1">
                        <div class="indemnitor-header">
                            <h3>Primary Indemnitor</h3>
                        </div>
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" class="ind-name" placeholder="Jane Doe">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">Phone</label>
                                <input type="tel" class="ind-phone" placeholder="(239) 555-5678">
                            </div>
                            <div class="form-group">
                                <label class="required">Email</label>
                                <input type="email" class="ind-email" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Relationship</label>
                            <select class="ind-relationship">
                                <option value="spouse">Spouse</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Sibling</option>
                                <option value="friend">Friend</option>
                                <option value="employer">Employer</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" class="ind-address" placeholder="Full address">
                        </div>
                    </div>
                </div>
                <button class="add-btn" onclick="addIndemnitor()">+ Add Another Indemnitor</button>
            </div>
        </div>
    </section>

    <!-- SECTION: Payment -->
    <section id="payment-section" class="section">
        <div class="card">
            <div class="card-header">
                <h2>üí∞ Payment Details</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Premium Rate</label>
                        <select id="premium-rate" onchange="calculatePayment()">
                            <option value="10">10% Standard</option>
                            <option value="8">8% Preferred</option>
                            <option value="15">15% High Risk</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Down Payment</label>
                        <input type="number" id="down-payment" placeholder="0.00" step="0.01" onchange="calculatePayment()">
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="payment-method">
                        <option value="cash">Cash</option>
                        <option value="credit">Credit Card</option>
                        <option value="debit">Debit Card</option>
                        <option value="financing">Financing</option>
                    </select>
                </div>

                <!-- Payment Summary -->
                <div class="payment-summary-card">
                    <h3>PAYMENT SUMMARY</h3>
                    <div class="payment-line">
                        <span>Total Bond</span>
                        <span id="pay-total-bond">$0.00</span>
                    </div>
                    <div class="payment-line">
                        <span>Premium (<span id="pay-rate">10</span>%)</span>
                        <span id="pay-premium">$0.00</span>
                    </div>
                    <div class="payment-line">
                        <span>Down Payment</span>
                        <span id="pay-down">$0.00</span>
                    </div>
                    <div class="payment-line total">
                        <span>Balance Due</span>
                        <span id="pay-balance">$0.00</span>
                    </div>
                </div>

                <!-- SwipeSimple Payment Link Button -->
                <button class="payment-link-btn" onclick="openPaymentLink()">
                    üí≥ Send Payment Link
                </button>
            </div>
        </div>
    </section>

    <!-- Bottom Action Bar -->
    <div class="action-bar">
        <button class="action-btn secondary" onclick="saveDraft()">
            <span class="action-icon">üíæ</span>
            <span>Save</span>
        </button>
        <button class="action-btn primary" onclick="generatePacket()">
            <span class="action-icon">üìÑ</span>
            <span>Generate</span>
        </button>
        <button class="action-btn success" onclick="sendForSigning()">
            <span class="action-icon">‚úçÔ∏è</span>
            <span>Sign</span>
        </button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Menu Modal -->
    <div class="modal" id="menu-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Options</h2>
                <button class="modal-close" onclick="hideMenu()">√ó</button>
            </div>
            <button class="add-btn" onclick="clearForm(); hideMenu();" style="margin-bottom:12px;">üóëÔ∏è Clear All Data</button>
            <button class="add-btn" onclick="switchToTablet(); hideMenu();">üì± Switch to Tablet View</button>
        </div>
    </div>

    <script>
        // =========================================================
        // CONFIGURATION
        // =========================================================
        const SWIPESIMPLE_PAYMENT_LINK = 'https://checkout.swipesimple.com/v2/pay/shamrock-bail-llc';
        let chargeCounter = 1;
        let indemnitorCounter = 1;

        // =========================================================
        // TAB NAVIGATION
        // =========================================================
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(tabName + '-section').classList.add('active');
        }

        // =========================================================
        // SUMMARY UPDATE
        // =========================================================
        function updateSummary() {
            const firstName = document.getElementById('def-first').value;
            const lastName = document.getElementById('def-last').value;
            const county = document.getElementById('def-county').value;
            
            if (firstName || lastName) {
                document.getElementById('quick-summary').style.display = 'block';
                document.getElementById('summary-name').textContent = `${firstName} ${lastName}`.trim() || '-';
                document.getElementById('summary-county').textContent = county + ' County';
            }
        }

        // =========================================================
        // CHARGE MANAGEMENT
        // =========================================================
        function addCharge() {
            chargeCounter++;
            const list = document.getElementById('charges-list');
            const html = `
                <div class="charge-item" data-id="${chargeCounter}">
                    <div class="charge-item-header">
                        <input type="text" class="charge-desc" placeholder="Charge description" style="flex:1; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:15px;">
                        <button class="charge-remove" onclick="removeCharge(this)">√ó</button>
                    </div>
                    <div class="charge-details">
                        <div class="form-group" style="margin:0;">
                            <input type="text" class="charge-bond" placeholder="Bond $" onchange="calculatePayment()" style="padding:12px;">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <select class="charge-type" style="padding:12px;">
                                <option value="M">Misdemeanor</option>
                                <option value="F">Felony</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', html);
        }

        function removeCharge(btn) {
            const items = document.querySelectorAll('.charge-item');
            if (items.length > 1) {
                btn.closest('.charge-item').remove();
                calculatePayment();
            } else {
                showToast('Need at least one charge', 'error');
            }
        }

        // =========================================================
        // INDEMNITOR MANAGEMENT
        // =========================================================
        function addIndemnitor() {
            indemnitorCounter++;
            const list = document.getElementById('indemnitors-list');
            const html = `
                <div class="indemnitor-item" data-id="${indemnitorCounter}">
                    <div class="indemnitor-header">
                        <h3>Indemnitor #${indemnitorCounter}</h3>
                        <button class="indemnitor-remove" onclick="removeIndemnitor(this)">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" class="ind-name" placeholder="Full Name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Phone</label>
                            <input type="tel" class="ind-phone" placeholder="(239) 555-5678">
                        </div>
                        <div class="form-group">
                            <label class="required">Email</label>
                            <input type="email" class="ind-email" placeholder="email@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Relationship</label>
                        <select class="ind-relationship">
                            <option value="spouse">Spouse</option>
                            <option value="parent">Parent</option>
                            <option value="sibling">Sibling</option>
                            <option value="friend">Friend</option>
                            <option value="employer">Employer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" class="ind-address" placeholder="Full address">
                    </div>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', html);
        }

        function removeIndemnitor(btn) {
            const items = document.querySelectorAll('.indemnitor-item');
            if (items.length > 1) {
                btn.closest('.indemnitor-item').remove();
            } else {
                showToast('Need at least one indemnitor', 'error');
            }
        }

        // =========================================================
        // PAYMENT CALCULATION
        // =========================================================
        function calculatePayment() {
            let totalBond = 0;
            document.querySelectorAll('.charge-bond').forEach(input => {
                totalBond += parseFloat(input.value.replace(/[^0-9.]/g, '')) || 0;
            });

            const rate = parseFloat(document.getElementById('premium-rate').value) / 100;
            const chargeCount = document.querySelectorAll('.charge-item').length;
            const premium = Math.max(totalBond * rate, chargeCount * 100);
            const down = parseFloat(document.getElementById('down-payment').value) || 0;
            const balance = Math.max(0, premium - down);

            // Update displays
            document.getElementById('pay-total-bond').textContent = formatCurrency(totalBond);
            document.getElementById('pay-rate').textContent = document.getElementById('premium-rate').value;
            document.getElementById('pay-premium').textContent = formatCurrency(premium);
            document.getElementById('pay-down').textContent = formatCurrency(down);
            document.getElementById('pay-balance').textContent = formatCurrency(balance);
            document.getElementById('summary-bond').textContent = formatCurrency(totalBond);
        }

        function formatCurrency(n) {
            return '$' + n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // =========================================================
        // PAYMENT LINK
        // =========================================================
        function openPaymentLink() {
            window.open(SWIPESIMPLE_PAYMENT_LINK, '_blank');
            showToast('Payment link opened', 'success');
        }

        // =========================================================
        // CLIPBOARD
        // =========================================================
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text.includes('bookingData=')) {
                    const data = JSON.parse(text.replace('bookingData=', ''));
                    if (data['defendant-first-name']) document.getElementById('def-first').value = data['defendant-first-name'];
                    if (data['defendant-last-name']) document.getElementById('def-last').value = data['defendant-last-name'];
                    if (data['defendant-dob']) document.getElementById('def-dob').value = data['defendant-dob'];
                    if (data['defendant-booking-number']) document.getElementById('def-booking').value = data['defendant-booking-number'];
                    updateSummary();
                    calculatePayment();
                    showToast('Data pasted!', 'success');
                } else {
                    showToast('No booking data found', 'error');
                }
            } catch (e) {
                showToast('Clipboard access denied', 'error');
            }
        }

        // =========================================================
        // FORM ACTIONS
        // =========================================================
        function collectFormData() {
            const defendant = {
                firstName: document.getElementById('def-first').value,
                lastName: document.getElementById('def-last').value,
                dob: document.getElementById('def-dob').value,
                phone: document.getElementById('def-phone').value,
                email: document.getElementById('def-email').value,
                bookingNumber: document.getElementById('def-booking').value,
                county: document.getElementById('def-county').value,
                arrestDate: document.getElementById('def-arrest-date').value
            };

            const charges = [];
            document.querySelectorAll('.charge-item').forEach(item => {
                charges.push({
                    description: item.querySelector('.charge-desc').value,
                    bondAmount: item.querySelector('.charge-bond').value,
                    type: item.querySelector('.charge-type').value
                });
            });

            const indemnitors = [];
            document.querySelectorAll('.indemnitor-item').forEach(item => {
                indemnitors.push({
                    name: item.querySelector('.ind-name').value,
                    phone: item.querySelector('.ind-phone').value,
                    email: item.querySelector('.ind-email').value,
                    relationship: item.querySelector('.ind-relationship').value,
                    address: item.querySelector('.ind-address').value
                });
            });

            const payment = {
                premiumRate: document.getElementById('premium-rate').value,
                downPayment: document.getElementById('down-payment').value,
                method: document.getElementById('payment-method').value
            };

            return { defendant, charges, indemnitors, payment, timestamp: new Date().toISOString() };
        }

        function saveDraft() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(() => { showLoading(false); showToast('Saved!', 'success'); })
                .withFailureHandler(e => { showLoading(false); showToast('Error: ' + e.message, 'error'); })
                .saveDraft(collectFormData());
        }

        function generatePacket() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(r => {
                    showLoading(false);
                    if (r.success) {
                        showToast('Packet ready!', 'success');
                        if (r.pdfUrl) window.open(r.pdfUrl, '_blank');
                    } else {
                        showToast(r.error || 'Failed', 'error');
                    }
                })
                .withFailureHandler(e => { showLoading(false); showToast('Error: ' + e.message, 'error'); })
                .generatePacketFromMobile(collectFormData());
        }

        function sendForSigning() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(r => {
                    showLoading(false);
                    showToast(r.success ? 'Sent for signing!' : (r.error || 'Failed'), r.success ? 'success' : 'error');
                })
                .withFailureHandler(e => { showLoading(false); showToast('Error: ' + e.message, 'error'); })
                .sendForSigningFromMobile(collectFormData());
        }

        function clearForm() {
            if (confirm('Clear all data?')) {
                document.querySelectorAll('input').forEach(i => { if (i.type !== 'button') i.value = ''; });
                document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                document.getElementById('quick-summary').style.display = 'none';
                calculatePayment();
                showToast('Cleared', 'success');
            }
        }

        // =========================================================
        // UI HELPERS
        // =========================================================
        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + type + ' show';
            setTimeout(() => t.className = 'toast', 3000);
        }

        function showLoading(show) {
            document.getElementById('loading').className = show ? 'loading-overlay show' : 'loading-overlay';
        }

        function showMenu() {
            document.getElementById('menu-modal').classList.add('show');
        }

        function hideMenu() {
            document.getElementById('menu-modal').classList.remove('show');
        }

        function switchToTablet() {
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=tablet';
        }

        // =========================================================
        // INIT
        // =========================================================
        document.addEventListener('DOMContentLoaded', function() {
            if (window.INJECTED_DATA) {
                // Populate from injected data
            }
            document.getElementById('def-arrest-date').value = new Date().toISOString().split('T')[0];
            calculatePayment();
        });
    </script>
</body>
</html>
