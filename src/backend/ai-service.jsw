import { getSecret } from 'wix-secrets-backend';
import { fetch } from 'wix-fetch';
import { searchCounties, getCountyBySlug } from 'backend/counties.jsw';
import { listCases } from 'backend/portal-api-client.jsw';

// ===================================
// Configuration
// ===================================

const MODEL = "gpt-4o-mini";
const SYSTEM_INSTRUCTION = `You are Shamrock Concierge, the AI assistant for Shamrock Bail Bonds.
Your goal is to assist users (Indemnitors and Defendants) with information about bail bonds, generating generic advice, or looking up specific information from our database.

You have access to tools to look up County/Jail information and User Case Status.
Always be polite, professional, and helpful.
If you don't know the answer, admit it and suggest they call our office at (239) 332-2245.

Privacy Rules:
- Do not reveal personal information about other users.
- Only provide Case Status if the user is authenticated (context provides a token).
`;

// ===================================
// Helper: OpenAI API Client
// ===================================

async function callOpenAI(messages, tools = []) {
    try {
        const apiKey = await getSecret("OPENAI_API_KEY");
        if (!apiKey) {
            throw new Error("Missing OPENAI_API_KEY secret");
        }

        const url = "https://api.openai.com/v1/chat/completions";

        const payload = {
            model: MODEL,
            messages: messages,
            temperature: 0.7
        };

        if (tools.length > 0) {
            payload.tools = tools;
        }

        let response;
        let error;

        // Simple Retry Logic (3 Attempts)
        for (let i = 0; i < 3; i++) {
            try {
                response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                // If 429 (Rate Limit) or 5xx (Server Error), we retry
                if (response.status === 429 || response.status >= 500) {
                    console.warn(`⚠️ OpenAI API Retry ${i + 1}/3 (Status: ${response.status})`);
                    await new Promise(r => setTimeout(r, 1000 * (i + 1))); // Linear backoff
                    continue;
                }

                break; // Exit loop on 200 or 400 (client error)
            } catch (err) {
                error = err;
                console.warn(`⚠️ OpenAI Network Retry ${i + 1}/3: ${err.message}`);
                await new Promise(r => setTimeout(r, 1000));
            }
        }

        if (!response && error) throw error;

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`OpenAI API Error: ${response.status} - ${errText}`);
        }

        const data = await response.json();
        return data.choices[0].message; // { role: "assistant", content: "...", tool_calls: [...] }

    } catch (error) {
        console.error("Error calling OpenAI:", error);
        throw error;
    }
}

// ===================================
// Tools Definition (OpenAI Format)
// ===================================

const OPENAI_TOOLS = [
    {
        type: "function",
        function: {
            name: "search_counties",
            description: "Search for Florida counties to find phone numbers, addresses, or sheriff websites.",
            parameters: {
                type: "object",
                properties: {
                    query: {
                        type: "string",
                        description: "The name of the county or city to search for (e.g., 'Lee', 'Miami')."
                    }
                },
                required: ["query"]
            }
        }
    },
    {
        type: "function",
        function: {
            name: "get_county_details",
            description: "Get detailed information about a specific county by its slug.",
            parameters: {
                type: "object",
                properties: {
                    slug: {
                        type: "string",
                        description: "The exact slug of the county (e.g., 'lee', 'collier')."
                    }
                },
                required: ["slug"]
            }
        }
    },
    {
        type: "function",
        function: {
            name: "list_my_cases",
            description: "List the active cases for the currently logged-in user.",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        }
    }
];

// ===================================
// Tool Executors
// ===================================

async function executeToolCall(toolCall, context) {
    const { name, arguments: argsString } = toolCall.function;
    const args = JSON.parse(argsString);

    try {
        switch (name) {
            case "search_counties":
                return await searchCounties(args.query);
            case "get_county_details":
                return await getCountyBySlug(args.slug);
            case "list_my_cases":
                if (!context.authToken) {
                    return { error: "User is not logged in. Cannot list cases." };
                }
                return await listCases({}, context.authToken);
            default:
                return { error: `Unknown tool: ${name}` };
        }
    } catch (err) {
        console.error(`Error executing tool ${name}:`, err);
        return { error: `Tool execution failed: ${err.message}` };
    }
}

// ===================================
// Main Exported Function
// ===================================

/**
 * Chat with the AI Agent.
 * @param {Array} history - Array of {role, content} objects.
 * @param {Object} context - { authToken: "..." }
 * @returns {Promise<Object>} The AI's response content { role: "assistant", content: "..." }
 */
export async function chatWithAgent(history, context = {}) {
    // OpenAI expects { role: "user" | "assistant" | "system", content: "..." }
    // Ensure history is in correct format
    const messages = [
        { role: "system", content: SYSTEM_INSTRUCTION },
        ...history.map(msg => ({
            role: msg.role,
            content: msg.content
        }))
    ];

    try {
        // 1. First call to LLM
        let message = await callOpenAI(messages, OPENAI_TOOLS);
        messages.push(message);

        // 2. Loop for Tool Calls (Agentic Loop)
        let turns = 0;
        const MAX_TURNS = 3;

        while (message.tool_calls && message.tool_calls.length > 0 && turns < MAX_TURNS) {
            turns++;

            // Execute all tool calls
            for (const toolCall of message.tool_calls) {
                const result = await executeToolCall(toolCall, context);

                messages.push({
                    role: "tool",
                    tool_call_id: toolCall.id,
                    content: JSON.stringify(result)
                });
            }

            // Call LLM again to generate final response
            message = await callOpenAI(messages, OPENAI_TOOLS);
            messages.push(message);
        }

        return {
            role: "assistant",
            content: message.content || ""
        };

    } catch (error) {
        console.error("AI Service Error:", error);
        return {
            role: "assistant",
            content: "I'm sorry, I encountered an error while processing your request. Please try again later."
        };
    }
}
