
import { generateMagicLink, onMagicLinkLoginV2, validateCustomSession } from 'backend/portal-auth';
import wixData from 'wix-data';

export async function testFullAuthFlow() {
    const logs = [];
    const log = (msg) => logs.push(`${new Date().toISOString()} - ${msg}`);

    try {
        log('üöÄ Starting Auth Flow Test');

        // 1. Generate Link
        const personId = 'test_user_' + Date.now();
        const role = 'defendant';
        const email = 'test@example.com';

        log(`1. Generating link for ${personId}...`);
        const token = await generateMagicLink(personId, role, null, { email, name: 'Test User' });

        if (!token) throw new Error('Token generation failed');
        log(`‚úÖ Token generated: ${token.substring(0, 5)}...`);

        // 2. Validate Link (Login)
        log('2. Validating link (Simulating Login)...');
        const loginResult = await onMagicLinkLoginV2(token);

        if (!loginResult.ok) throw new Error(`Login failed: ${loginResult.message}`);
        log(`‚úÖ Login successful. Session Token: ${loginResult.sessionToken?.substring(0, 5)}...`);

        // 3. Validate Session
        const sessionToken = loginResult.sessionToken;
        log('3. Validating Session Token...');
        const sessionResult = await validateCustomSession(sessionToken);

        if (!sessionResult.valid) throw new Error(`Session validation failed: ${sessionResult.reason}`);
        log(`‚úÖ Session Validated! Person: ${sessionResult.personId}, Role: ${sessionResult.role}`);

        // 4. Verify Collections
        log('4. Verifying DB Records...');
        const linkRecord = await wixData.query('Magiclinks').eq('token', token).find({ suppressAuth: true });
        if (linkRecord.items.length === 0) throw new Error('Magic Link record missing');
        if (!linkRecord.items[0].used) throw new Error('Magic Link not marked as USED');
        log('‚úÖ Magic Link marked used correctly.');

        const sessionRecord = await wixData.query('Portal Sessions').eq('sessionToken', sessionToken).find({ suppressAuth: true });
        if (sessionRecord.items.length === 0) throw new Error('Session record missing');
        if (!sessionRecord.items[0].isActive) throw new Error('Session is not ACTIVE');
        log('‚úÖ Session record exists and is active.');


        log('üéâ TEST PASSED: Full flow is healthy.');

        // 5. Extra: Test Email Lookup (Simulate Social Login)
        log('5. Testing Email Lookup (Social Simulation)...');
        const emailLookup = await lookupUserByContact('test@example.com');
        // We expect it to be NOT FOUND unless we seeded it, or FOUND if seeded. 
        // Just checking it doesn't crash.
        log(`   - Lookup result for 'test@example.com': ${emailLookup.found ? 'FOUND' : 'NOT FOUND'} (OK)`);

        return { success: true, logs: logs };

    } catch (error) {

        log(`‚ùå TEST FAILED: ${error.message}`);
        console.error("Auth Test Failed:", error);
        return { success: false, logs: logs, error: error.message };
    }
}
