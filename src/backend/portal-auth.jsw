/**
 * backend/portal-auth.jsw
 * FIXED VERSION: Corrected wix-secrets-backend import and Date objects
 */

import wixData from "wix-data";
import wixUsersBackend from "wix-users-backend";
import { fetch } from "wix-fetch";
// FIX 1: Correct Import
import { getSecret } from "wix-secrets-backend";
import { API_BASE_URL, API_TIMEOUT } from 'public/portal-config';
import { sendSms } from 'backend/twilio-client'; // FIX: Single Twilio Import
import { generateToken } from 'backend/utils';

/***** CONFIG & ROLES *****/
export const ROLES = {
  DEFENDANT: "defendant",
  INDEMNITOR: "indemnitor",
  COINDEMNITOR: "coindemnitor",
  STAFF: "staff",
  ADMIN: "admin",
};

// timeouts (ms)
const SESSION_TIMEOUT = 1000 * 60 * 60 * 24; // 24h
const MAGIC_LINK_EXPIRATION = 1000 * 60 * 60 * 24; // 24h

// page paths (Wix page URLs)
const PORTAL_PATHS = {
  [ROLES.DEFENDANT]: "/portal-defendant",
  [ROLES.INDEMNITOR]: "/portal-indemnitor",
  [ROLES.COINDEMNITOR]: "/portal-indemnitor",
  [ROLES.STAFF]: "/portal-staff",
  [ROLES.ADMIN]: "/portal-staff",
};

/***** CURRENT USER HELPERS (backend) *****/
export async function getCurrentUser() {
  const user = await wixUsersBackend.getCurrentUser();
  if (!user) return null;
  const email = (await user.getEmail())?.toLowerCase?.();
  const role = await getUserRole();
  // from PortalUsers collection
  return { id: user.id, email, role, loggedIn: true };
}

export async function isLoggedIn() {
  const user = await wixUsersBackend.getCurrentUser();
  return !!user;
}

export async function getUserRole() {
  const user = await wixUsersBackend.getCurrentUser();
  if (!user) return null;
  // Look up role in PortalUsers collection (admin bypass to ensure we can read it)
  const rs = await wixData
    .query("Portal Users")
    .eq("userId", user.id)
    .limit(1)
    .find({ suppressAuth: true });
  if (rs.items.length) {
    const role = (rs.items[0].role || "").toLowerCase();
    return Object.values(ROLES).includes(role) ? role : null;
  }
  return null;
}

export async function hasRole(role) {
  const r = await getUserRole();
  return r === role;
}

export async function isStaff() {
  const r = await getUserRole();
  return r === ROLES.STAFF || r === ROLES.ADMIN;
}

export async function isDefendant() {
  return hasRole(ROLES.DEFENDANT);
}

export async function isIndemnitor() {
  const r = await getUserRole();
  return r === ROLES.INDEMNITOR || r === ROLES.COINDEMNITOR;
}

/***** SESSION STORAGE (PortalSessions collection) *****/
export async function setSessionData(key, value) {
  try {
    const user = await wixUsersBackend.getCurrentUser();
    if (!user) return;

    const sessionData = {
      key,
      value: JSON.stringify(value),
      timestamp: new Date(), // Use Date object
      userId: user.id,
    };
    await wixData.save("Portal Sessions", sessionData, { suppressAuth: true });
  } catch (e) {
    console.error("setSessionData error:", e);
  }
}

export async function getSessionData(key) {
  try {
    const user = await wixUsersBackend.getCurrentUser();
    if (!user) return null;
    const rs = await wixData
      .query("Portal Sessions")
      .eq("key", key)
      .eq("userId", user.id)
      .limit(1)
      .find({ suppressAuth: true });
    if (!rs.items.length) return null;

    const item = rs.items[0];
    if (Date.now() - new Date(item.timestamp).getTime() > SESSION_TIMEOUT) {
      await wixData.remove("Portal Sessions", item._id, { suppressAuth: true });
      return null;
    }
    return JSON.parse(item.value);
  } catch (e) {
    console.error("getSessionData error:", e);
    return null;
  }
}

export async function clearSessionData(key = null) {
  try {
    const user = await wixUsersBackend.getCurrentUser();
    if (!user) return;

    let q = wixData.query("Portal Sessions").eq("userId", user.id);
    if (key) q = q.eq("key", key);
    const rs = await q.find({ suppressAuth: true });
    await Promise.all(
      rs.items.map((i) => wixData.remove("Portal Sessions", i._id, { suppressAuth: true }))
    );
  } catch (e) {
    console.error("clearSessionData error:", e);
  }
}

/***** MAGIC LINKS (Magiclinks collection) *****/
// Generates and stores a token (for staff-initiated sends)
export async function generateMagicLink(personId, role, caseId = null) {
  const token = generateToken();
  const now = Date.now();
  const doc = {
    token,
    personId,
    role: (role || "").toLowerCase(),
    caseId,
    createdAt: new Date(now), // Use Date object
    expiresAt: new Date(now + MAGIC_LINK_EXPIRATION), // Use Date object
    used: false,
  };
  await wixData.save("Magiclinks", doc, { suppressAuth: true });
  return token;
}

export async function validateMagicLink(token) {
  const rs = await wixData
    .query("Magiclinks")
    .eq("token", token)
    .eq("used", false)
    .limit(1)
    .find({ suppressAuth: true });
  if (!rs.items.length) return null;

  const link = rs.items[0];
  if (Date.now() > new Date(link.expiresAt).getTime()) return null;

  return link;
  // { token, personId, role, caseId, ... }
}

export async function useMagicLink(token) {
  const rs = await wixData
    .query("Magiclinks")
    .eq("token", token)
    .limit(1)
    .find({ suppressAuth: true });
  if (!rs.items.length) return false;

  const link = rs.items[0];
  link.used = true;
  link.usedAt = new Date();
  // Use Date object
  await wixData.update("Magiclinks", link, { suppressAuth: true });
  return true;
}

/**
 * Handles token redemption from the landing page.
 * - Validates token
 * - Links user profile to person/case
 * - Sets/updates role on PortalUsers
 * - Returns { ok, role, caseId, goto }
 */
export async function onMagicLinkLogin(token) {
  if (!token || typeof token !== "string") return { ok: false, error: "MISSING_TOKEN", message: "No secure token provided." };

  try {
    const link = await validateMagicLink(token);
    if (!link) {
      return { ok: false, error: "INVALID_OR_EXPIRED", message: "This secure link has expired or has already been used. Please request a new one." };
    }

    const user = await wixUsersBackend.getCurrentUser();
    if (!user) {
      return { ok: false, error: "LOGIN_REQUIRED", message: "Please log in or sign up to activate your portal access." };
    }

    // Upsert PortalUsers profile with role, personId, caseIds[]
    const profile = await getUserProfile();
    const caseIds = Array.isArray(profile?.caseIds) ? profile.caseIds : [];
    if (link.caseId && !caseIds.includes(link.caseId)) caseIds.push(link.caseId);

    // FIX 2: Use new Date() object, NOT .toISOString() for Wix Data
    const updated = {
      ...(profile || {}),
      userId: user.id,
      personId: link.personId || profile?.personId,
      role: (link.role || profile?.role || "").toLowerCase(),
      caseIds,
      updatedAt: new Date(),
      createdAt: profile?.createdAt || new Date(),
    };
    await saveUserProfile(updated);

    await useMagicLink(token);

    const role = updated.role || null;
    const caseId = link.caseId || null;
    const goto = role ? PORTAL_PATHS[role] || "/portal-landing" : "/portal-landing";

    return { ok: true, role, caseId, goto, message: "Access granted! Welcome to your dashboard." };
  } catch (err) {
    console.error("onMagicLinkLogin error:", err);
    return { ok: false, error: "SERVER_ERROR", message: "Server Error: " + err.message };
  }
}

/***** EMAIL SENDER *****/
export async function sendMagicLink(email, token, role, personName = null) {
  // Build the correct page URL for role (token redeemed on that page)
  const base = "https://www.shamrockbailbonds.biz";
  const path = "/portal-landing"; // Always land on portal-landing with token
  const portalUrl = `${base}${path}?token=${encodeURIComponent(token)}`;
  try {
    // FIX 1: Correct getSecret Usage
    const gasUrl = await getSecret('GAS_WEB_APP_URL');

    if (!gasUrl) {
      console.warn('GAS_WEB_APP_URL not configured, cannot send email');
      return { success: false, error: 'Email service not configured' };
    }

    const roleDisplayNames = {
      'defendant': 'Defendant',
      'indemnitor': 'Indemnitor',
      'coindemnitor': 'Co-Indemnitor',
      'staff': 'Staff',
      'admin': 'Admin'
    };
    const roleName = roleDisplayNames[role] || 'User';

    // DETECT SMS vs EMAIL
    // Simple check: if it looks like a phone (only digits/plus/dash/space and < 5 chars of alpha), treat as SMS
    // Ideally we pass a type, but for backward compat we sniff it
    const isEmail = email.includes('@');

    if (!isEmail) {
      // --- SMS PATH ---
      const loginLink = `${portalUrl}`;
      // Short message for SMS
      const smsBody = `Shamrock Portal: Your login code is ${token}\n\nLink: ${loginLink}\n\n(Expires in 24h)`;

      const smsResult = await sendSms(email, smsBody);
      if (smsResult.success) {
        console.log(`âœ… Text sent to ${email} (${role})`);
        return { success: true };
      } else {
        console.warn("âš ï¸ SMS failed, falling back/error", smsResult.error);
        return { success: false, error: smsResult.error };
      }
    }

    // --- EMAIL PATH (Existing) ---
    const greeting = personName ? `Hello ${personName}` : `Hello`;
    const emailBody = `
      <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
          <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
            <h2 style="color: #1a5490;">Shamrock Bail Bonds - Portal Access</h2>
            <p>${greeting},</p>
            <p>You've been granted access to the Shamrock Bail Bonds ${roleName} Portal.</p>
            <p>Click the button below to securely log in:</p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="${portalUrl}" 
                 style="background-color: #1a5490; color: white; padding: 15px 30px; 
                        text-decoration: none; border-radius: 5px; display: inline-block; 
                        font-weight: bold;">Access Your Portal</a>
            </div>
            <p style="font-size: 12px; color: #666;">
              Or copy and paste this link into your browser:<br>
              <a href="${portalUrl}">${portalUrl}</a>
            </p>
            <p style="font-size: 12px; color: #666;">
              <strong>Access Code:</strong> ${token}<br>
              You can also enter this code manually on the portal landing page.
            </p>
            <p style="font-size: 12px; color: #666; margin-top: 30px;">
              This link will expire in 24 hours for security purposes.
            </p>
            <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">
            <p style="font-size: 11px; color: #999;">
              Shamrock Bail Bonds<br>
              <a href="https://www.shamrockbailbonds.biz">www.shamrockbailbonds.biz</a>
            </p>
          </div>
        </body>
      </html>
    `;

    const response = await fetch(gasUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'sendEmail',
        to: email,
        subject: `Shamrock Bail Bonds - ${roleName} Portal Access`,
        htmlBody: emailBody,
        textBody: `${greeting},\n\nYou've been granted access to the Shamrock Bail Bonds ${roleName} Portal.\n\nAccess your portal: ${portalUrl}\n\nOr enter this access code manually: ${token}\n\nThis link expires in 24 hours.\n\nShamrock Bail Bonds\nwww.shamrockbailbonds.biz`
      })
    });

    if (response.ok) {
      console.log(`Magic link email sent to [REDACTED] for role ${role}`);
      return { success: true };
    } else {
      console.error('Failed to send magic link email:', await response.text());
      return { success: false, error: 'Email send failed' };
    }

  } catch (error) {
    console.error('Error sending magic link email:', error);
    return { success: false, error: error.message };
  }
}

/***** USER PROFILE CRUD (PortalUsers collection) *****/
export async function getUserProfile(userId) {
  const user = await wixUsersBackend.getCurrentUser();
  const id = userId || user?.id;
  if (!id) return null;
  const rs = await wixData
    .query("Portal Users")
    .eq("userId", id)
    .limit(1)
    .find({ suppressAuth: true });
  return rs.items[0] || null;
}

export async function saveUserProfile(profile) {
  // Ensure we save with admin permissions
  const options = { suppressAuth: true };
  if (profile._id) return wixData.update("Portal Users", profile, options);
  return wixData.save("Portal Users", profile, options);
}

export async function linkUserToPerson(personId) {
  const p = (await getUserProfile()) || {};
  p.personId = personId;
  p.updatedAt = new Date();
  if (!p.createdAt) p.createdAt = p.updatedAt;
  await saveUserProfile(p);
  return true;
}

export async function getPersonId() {
  const p = await getUserProfile();
  return p?.personId || null;
}

export async function linkUserToCase(caseId) {
  const p = (await getUserProfile()) || {};
  const list = Array.isArray(p.caseIds) ? p.caseIds : [];
  if (!list.includes(caseId)) list.push(caseId);
  p.caseIds = list;
  p.updatedAt = new Date();
  if (!p.createdAt) p.createdAt = p.updatedAt;
  await saveUserProfile(p);
  return true;
}

export async function getCaseIds() {
  const p = await getUserProfile();
  return Array.isArray(p?.caseIds) ? p.caseIds : [];
}

/***** AUTHZ HELPERS *****/
export async function canAccessCase(caseId) {
  if (await isStaff()) return true;
  const cases = await getCaseIds();
  return cases.includes(caseId);
}

// Helper to let a user self-select a role (e.g. during onboarding)
export async function assignRoleToCurrentUser(roleName) {
  const user = await wixUsersBackend.getCurrentUser();
  if (!user) throw new Error("Must be logged in");

  const validRoles = [ROLES.DEFENDANT, ROLES.INDEMNITOR];
  // Only allow public selection of these
  if (!validRoles.includes(roleName)) throw new Error("Invalid role selection");
  const profile = await getUserProfile(user.id) || {};

  // Update/Create profile
  const updated = {
    ...profile,
    userId: user.id,
    role: roleName,
    updatedAt: new Date()
  };
  await saveUserProfile(updated);
  return true;
}

export async function requireAuth() {
  if (!(await isLoggedIn())) throw new Error("Authentication required");
}

export async function requireRole(role) {
  await requireAuth();
  if (!(await hasRole(role))) throw new Error(`Role ${role} required`);
}

export async function requireStaff() {
  await requireAuth();
  if (!(await isStaff())) throw new Error("Staff access required");
}

/***** CUSTOM SESSION MANAGEMENT (No Wix Members Required) *****/
/**
 * Creates a custom session token and stores it in PortalSessions
 * Returns the token to be stored in browser localStorage
 */
export async function createCustomSession(personId, role, caseId = null) {
  const sessionToken = generateToken();
  const now = Date.now();

  const sessionData = {
    token: sessionToken,
    personId,
    role: (role || "").toLowerCase(),
    caseId,
    createdAt: new Date(now), // Use Date object
    expiresAt: new Date(now + SESSION_TIMEOUT), // Use Date object
    lastActivity: new Date(now), // Use Date object
  };
  await wixData.save("Portal Sessions", sessionData, { suppressAuth: true });
  return sessionToken;
}

/**
 * Validates a custom session token from browser localStorage
 * Returns session data if valid, null if invalid/expired
 */
/**
 * Validates a custom session token from browser localStorage
 * Returns session data if valid, null if invalid/expired
 */
export async function validateCustomSession(sessionToken) {
  if (!sessionToken || typeof sessionToken !== "string") {
    console.warn("validateCustomSession: Empty token provided");
    return null;
  }
  try {
    const rs = await wixData
      .query("Portal Sessions")
      .eq("token", sessionToken)
      .limit(1)
      .find({ suppressAuth: true });

    if (!rs.items.length) {
      console.warn("validateCustomSession: Token not found in DB:", sessionToken.substring(0, 5) + "...");
      return null;
    }

    const session = rs.items[0];
    const now = Date.now();

    // Safety check for expiresAt
    const expiresAt = session.expiresAt ? new Date(session.expiresAt).getTime() : 0;

    // Check if expired
    if (now > expiresAt) {
      console.warn("validateCustomSession: Session expired");
      await wixData.remove("Portal Sessions", session._id, { suppressAuth: true });
      return null;
    }

    // Update last activity
    session.lastActivity = new Date(now);
    await wixData.update("Portal Sessions", session, { suppressAuth: true });

    return {
      personId: session.personId,
      role: session.role,
      caseId: session.caseId,
      token: session.token
    };
  } catch (err) {
    console.error("validateCustomSession error:", err);
    return null;
  }
}

/**
 * Destroys a custom session (logout)
 * @param {string} sessionToken - The session token to destroy
 */
export async function destroyCustomSession(sessionToken) {
  if (!sessionToken) return false;
  try {
    const rs = await wixData
      .query("Portal Sessions")
      .eq("token", sessionToken)
      .limit(1)
      .find({ suppressAuth: true });
    
    if (rs.items.length > 0) {
      await wixData.remove("Portal Sessions", rs.items[0]._id, { suppressAuth: true });
      console.log("Custom session destroyed successfully");
      return true;
    }
    return false;
  } catch (err) {
    console.error("destroyCustomSession error:", err);
    return false;
  }
}

/**
 * Magic Link Login V2 - Custom Session Based (No Wix Members)
 * Called when user clicks magic link from email/SMS
 * Creates a custom session and returns session token for browser storage
 * 
 * @param {string} token - The magic link token from URL
 * @returns {Promise<{ok: boolean, sessionToken?: string, role?: string, caseId?: string, error?: string, message?: string}>}
 */
export async function onMagicLinkLoginV2(token) {
  if (!token || typeof token !== "string") {
    return { 
      ok: false, 
      error: "MISSING_TOKEN", 
      message: "No secure token provided." 
    };
  }

  try {
    // 1. Validate the magic link token
    const link = await validateMagicLink(token);
    if (!link) {
      return { 
        ok: false, 
        error: "INVALID_OR_EXPIRED", 
        message: "This secure link has expired or has already been used. Please request a new one." 
      };
    }

    // 2. Mark the magic link as used
    await useMagicLink(token);

    // 3. Create a custom session (No Wix Members required)
    const sessionToken = await createCustomSession(
      link.personId,
      link.role,
      link.caseId
    );

    if (!sessionToken) {
      return { 
        ok: false, 
        error: "SESSION_CREATION_FAILED", 
        message: "Failed to create session. Please try again." 
      };
    }

    // 4. Determine redirect path based on role
    const role = (link.role || "").toLowerCase();
    const goto = role ? PORTAL_PATHS[role] || "/portal-landing" : "/portal-landing";

    console.log(`âœ… Magic Link V2 Login Success: role=${role}, personId=${link.personId}`);

    return { 
      ok: true, 
      sessionToken,
      role,
      caseId: link.caseId || null,
      goto,
      message: "Access granted! Welcome to your dashboard." 
    };

  } catch (err) {
    console.error("onMagicLinkLoginV2 error:", err);
    return { 
      ok: false, 
      error: "SERVER_ERROR", 
      message: "Server Error: " + err.message 
    };
  }
}

/**
 * Cleanup expired sessions and magic links
 * Should be called periodically (e.g., via scheduled job)
 */
export async function cleanupExpiredSessions() {
  try {
    const now = new Date();
    
    // Cleanup expired sessions
    const expiredSessions = await wixData
      .query("Portal Sessions")
      .lt("expiresAt", now)
      .limit(100)
      .find({ suppressAuth: true });
    
    for (const session of expiredSessions.items) {
      await wixData.remove("Portal Sessions", session._id, { suppressAuth: true });
    }
    
    // Cleanup expired magic links
    const expiredLinks = await wixData
      .query("Magiclinks")
      .lt("expiresAt", now)
      .limit(100)
      .find({ suppressAuth: true });
    
    for (const link of expiredLinks.items) {
      await wixData.remove("Magiclinks", link._id, { suppressAuth: true });
    }
    
    console.log(`Cleanup: Removed ${expiredSessions.items.length} sessions, ${expiredLinks.items.length} magic links`);
    return { 
      success: true, 
      sessionsRemoved: expiredSessions.items.length,
      linksRemoved: expiredLinks.items.length
    };
  } catch (err) {
    console.error("cleanupExpiredSessions error:", err);
    return { success: false, error: err.message };
  }
}

/***** DATA AGGREGATION *****/
export async function getDefendantDetails(sessionTokenOrUserId) {
  // 1. Resolve Identity
  let personId = sessionTokenOrUserId;
  let role = 'defendant';

  // Try to resolve as session token first (Magic Link Flow)
  try {
    const session = await validateCustomSession(sessionTokenOrUserId);
    if (session) {
      personId = session.personId;
      role = session.role;
    }
  } catch (e) {
    console.warn("getDefendantDetails: Token validation error, trying as raw ID");
  }

  // 2. Fetch from Cases (Source of Truth) using personId (which is Case._id or linked ID)
  // If personId starts with 'new_', it's an empty shell.
  if (personId && personId.startsWith('new_')) {
    return {
      firstName: "New Client",
      caseNumber: "Pending",
      bondAmount: "$0.00",
      nextCourtDate: "TBD",
      caseStatus: "Pending",
      paperworkStatus: "Incomplete",
      signingStatus: "Waiting",
      charges: "",
      county: ""
    };
  }

  // Query Cases directly
  let caseData = {};
  if (personId) {
    try {
      const caseQuery = await wixData.query("Cases")
        .eq("_id", personId) // personId from magic link is Case ID
        .limit(1)
        .find({ suppressAuth: true });

      if (caseQuery && caseQuery.items.length > 0) {
        const c = caseQuery.items[0];
        caseData = {
          caseNumber: c.caseNumber,
          bondAmount: c.bondAmount,
          nextCourtDate: c.nextCourtDate,
          caseStatus: c.status,
          charges: c.charges,
          county: c.county,
          firstName: c.defendantName ? c.defendantName.split(' ')[0] : "Client",
          defendantName: c.defendantName,
          email: c.defendantEmail,
          phone: c.defendantPhone
        };
      }
    } catch (err) {
      console.warn("getDefendantDetails: Case lookup failed", err);
    }
  }

  // 3. Fallback: Check PortalUsers (Legacy/WixMember Flow)
  if (!caseData.caseNumber && personId) {
    const profile = await getUserProfile(personId); // Pass personId/userId
    if (profile && profile.caseIds && profile.caseIds.length > 0) {
      // ... (existing logic to query by caseNumber)
    }
  }

  const details = {
    firstName: caseData.firstName || "Client",
    caseNumber: caseData.caseNumber || "Pending",
    bondAmount: caseData.bondAmount || "$0.00",
    nextCourtDate: caseData.nextCourtDate || "TBD",
    caseStatus: caseData.caseStatus || "Active",
    paperworkStatus: "Incomplete",
    signingStatus: "Waiting",
    charges: caseData.charges || "",
    county: caseData.county || "",
    email: caseData.email || "",
    ...caseData
  };
  return details;
}

export async function getIndemnitorDetails(token) {
  const session = await validateCustomSession(token);
  if (!session || !session.personId) {
    console.warn("getIndemnitorDetails: Invalid session token provided.");
    throw new Error("Unauthorized: Invalid session");
  }

  const personId = session.personId;

  try {
    const result = await wixData.query("FinancialObligations")
      .eq("personid", personId)
      .limit(1)
      .find({ suppressAuth: true });
    if (result.items.length === 0) {
      console.warn(`No financial obligations found for personId: ${personId}`);
      return {
        totalLiability: "$0.00",
        totalPremium: "$0.00",
        downPayment: "$0.00",
        balanceDue: "$0.00",
        chargesCount: 0,
        defendantName: "N/A",
        defendantStatus: "Unknown",
        lastCheckIn: "Never",
        nextCourtDate: "TBD"
      };
    }

    const data = result.items[0];

    return {
      totalLiability: data.totalliability || "$0.00",
      totalPremium: data.totalpremium || "$0.00",
      downPayment: data.downpayment || "$0.00",
      balanceDue: data.balancedue || "$0.00",
      chargesCount: Number(data.chargescount) || 0,
      defendantName: data.defendantname || "",
      defendantStatus: data.defendantstatus || "",
      lastCheckIn: data.lastcheckin || "",
      nextCourtDate: data.nextcourtdate || ""
    };
  } catch (error) {
    console.error("Error fetching indemnitor details:", error);
    throw error;
  }
}

export async function getStaffDashboardData() {
  await requireStaff();

  let rawCases = [];
  try {
    const result = await wixData.query("Cases")
      .limit(100)
      .descending("_createdDate")
      .find({ suppressAuth: true });
    rawCases = result.items;
  } catch (err) {
    console.error("getStaffDashboardData: Failed to query Cases", err);
    rawCases = [];
  }

  const cases = rawCases.map(c => ({
    _id: c._id,
    caseNumber: c.caseNumber || "UNK",
    defendantName: c.defendantName || "Unknown",
    bondAmount: c.bondAmount || "$0.00",
    status: c.status || "Pending",
    paperworkStatus: c.paperworkStatus || "Incomplete",
    phone: c.defendantPhone || "",
    defendantEmail: c.defendantEmail || ""
  }));
  const stats = {
    activeCases: cases.filter(c => c.status === 'Active' || c.status === 'open').length,
    pendingSignatures: cases.filter(c => c.paperworkStatus === 'Sent' || c.paperworkStatus === 'Pending').length,
    completedToday: 0,
    failedChecks: 0
  };

  return { stats, cases };
}

export async function getUserConsentStatus(personId) {
  if (!personId) return false;
  try {
    const result = await wixData.query("Portal Users")
      .eq("personId", personId)
      .limit(1)
      .find({ suppressAuth: true });
    if (result.items.length > 0) {
      return result.items[0].consent === true;
    }
    return false;
  } catch (e) {
    console.error("getUserConsentStatus error:", e);
    return false;
  }
}

/***** SIMPLIFIED LOGIN SYSTEM *****/
export async function sendMagicLinkSimplified(emailOrPhone) {
  if (!emailOrPhone || typeof emailOrPhone !== 'string') {
    return {
      success: false,
      message: "Please enter a valid email or phone number."
    };
  }

  const input = emailOrPhone.trim().toLowerCase();

  try {
    const isEmail = input.includes('@');
    
    // Field names matching Wix CMS Cases collection
    // Using the actual field keys from the collection schema
    const defendantEmailField = 'defendantEmail';
    const defendantPhoneField = 'defendantPhone';
    const defendantNameField = 'defendantName';
    const indemnitorEmailField = 'indemnitorEmail';
    const indemnitorPhoneField = 'indemnitorPhone';
    const indemnitorNameField = 'indemnitorName';
    
    const searchField = isEmail ? defendantEmailField : defendantPhoneField;
    console.log(`ðŸ” Searching Cases collection for ${searchField} = ${input}`);

    let userRole = null;
    let personId = null;
    let userName = null;
    let isNewUser = false;
    let caseId = null;
    
    // Search for defendant
    const caseQuery = await wixData
      .query("Cases")
      .eq(searchField, input)
      .limit(1)
      .find({ suppressAuth: true });

    console.log(`ðŸ“Š Defendant query returned ${caseQuery.items.length} results`);

    if (caseQuery.items.length > 0) {
      const caseData = caseQuery.items[0];
      userRole = ROLES.DEFENDANT;
      personId = caseData._id;
      caseId = caseData._id;
      userName = caseData[defendantNameField] || caseData.title || 'Client';
      isNewUser = false;
      console.log(`âœ… Existing defendant found: ${userName}, caseId: ${caseId}`);
    } else {
      // Search for indemnitor
      const indemnitorSearchField = isEmail ? indemnitorEmailField : indemnitorPhoneField;
      console.log(`ðŸ” Searching for indemnitor: ${indemnitorSearchField} = ${input}`);
      
      const indemnitorQuery = await wixData
        .query("Cases")
        .eq(indemnitorSearchField, input)
        .limit(1)
        .find({ suppressAuth: true });
        
      console.log(`ðŸ“Š Indemnitor query returned ${indemnitorQuery.items.length} results`);
      
      if (indemnitorQuery.items.length > 0) {
        const caseData = indemnitorQuery.items[0];
        userRole = ROLES.INDEMNITOR;
        personId = `indemnitor_${caseData._id}`;
        caseId = caseData._id;
        userName = caseData[indemnitorNameField] || 'Indemnitor';
        isNewUser = false;
        console.log(`âœ… Existing indemnitor found: ${userName}, caseId: ${caseId}`);
      } else {
        // New user - allow them to proceed
        userRole = ROLES.DEFENDANT;
        personId = `new_${Date.now()}`;
        userName = null;
        isNewUser = true;
        console.log(`ðŸ†• New user detected: ${input}`);
      }
    }

    // Generate magic link token with caseId
    const token = await generateMagicLink(personId, userRole, caseId);
    console.log(`ðŸ”‘ Generated magic link token for ${userRole}`);
    
    // Send magic link via email or SMS
    const sendResult = await sendMagicLink(
      input,
      token,
      userRole,
      userName
    );
    
    if (!sendResult.success) {
      console.error(`âŒ Failed to send magic link to ${input}:`, sendResult.error);
      return {
        success: false,
        message: "Unable to send secure link. Please try again or call 239-332-2245."
      };
    }

    console.log(`âœ… Magic link sent successfully to ${input}`);
    return {
      success: true,
      isNewUser: isNewUser,
      message: isNewUser
        ? "Welcome! Check your email/phone for your secure link."
        : "Check your email/phone for your secure link."
    };
  } catch (error) {
    console.error("âŒ sendMagicLinkSimplified error:", error.message, error.stack);
    // Return detailed error for debugging (remove in production)
    return {
      success: false,
      message: `Error: ${error.message}. Please try again or call 239-332-2245.`,
      debug: error.stack
    };
  }
}

export async function lookupUserByContact(emailOrPhone) {
  if (!emailOrPhone) {
    return { found: false };
  }

  const input = emailOrPhone.trim().toLowerCase();
  const isEmail = input.includes('@');
  const searchField = isEmail ? 'defendantEmail' : 'defendantPhone';
  try {
    const defendantQuery = await wixData
      .query("Cases")
      .eq(searchField, input)
      .limit(1)
      .find({ suppressAuth: true });
    if (defendantQuery.items.length > 0) {
      const data = defendantQuery.items[0];
      return {
        found: true,
        role: ROLES.DEFENDANT,
        name: data.defendantName,
        caseId: data.caseNumber,
        personId: data._id
      };
    }

    const indemnitorQuery = await wixData
      .query("Cases")
      .eq(isEmail ? 'indemnitorEmail' : 'indemnitorPhone', input)
      .limit(1)
      .find({ suppressAuth: true });
    if (indemnitorQuery.items.length > 0) {
      const data = indemnitorQuery.items[0];
      return {
        found: true,
        role: ROLES.INDEMNITOR,
        name: data.indemnitorName,
        caseId: data.caseNumber,
        personId: `indemnitor_${data._id}`
      };
    }

    return { found: false };

  } catch (error) {
    console.error("lookupUserByContact error:", error);
    return { found: false };
  }
}
