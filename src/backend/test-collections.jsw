/**
 * Test Collections Module
 * backend/test-collections.jsw
 * 
 * Test functions to verify Portal Sessions and Magiclinks collections exist and work
 * 
 * @version 1.0.0
 * @created 2026-02-02
 */

import wixData from 'wix-data';

/**
 * Test if Portal Sessions collection exists and is functional
 */
export async function testPortalSessionsCollection() {
    try {
        console.log('üß™ Testing Portal Sessions collection...');

        // Try to insert a test session
        const testSession = {
            sessionToken: `test_${Date.now()}`,
            personId: 'test@example.com',
            role: 'indemnitor',
            createdAt: new Date(),
            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
            isActive: true
        };

        const insertResult = await wixData.insert('PortalSessions', testSession, { suppressAuth: true });
        console.log('‚úÖ Insert successful:', insertResult._id);

        // Try to query it back
        const queryResult = await wixData.query('PortalSessions')
            .eq('sessionToken', testSession.sessionToken)
            .find({ suppressAuth: true });

        if (queryResult.items.length > 0) {
            console.log('‚úÖ Query successful: Found', queryResult.items.length, 'item(s)');
        } else {
            console.warn('‚ö†Ô∏è Query returned 0 results (unexpected)');
        }

        // Clean up test data
        await wixData.remove('PortalSessions', insertResult._id, { suppressAuth: true });
        console.log('‚úÖ Cleanup successful');

        return {
            success: true,
            message: 'Portal Sessions collection is working correctly',
            testId: insertResult._id
        };

    } catch (error) {
        console.error('‚ùå Portal Sessions collection error:', error);
        return {
            success: false,
            error: error.message,
            hint: 'Collection might not exist. Create it in Wix CMS using Portal_Sessions_Template.csv'
        };
    }
}

/**
 * Test if Magiclinks collection exists and is functional
 */
export async function testMagiclinksCollection() {
    try {
        console.log('üß™ Testing Magiclinks collection...');

        // Try to insert a test magic link
        const testLink = {
            token: `test_${Date.now()}`,
            contact: 'test@example.com',
            role: 'indemnitor',
            createdAt: new Date(),
            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
            used: false
        };

        const insertResult = await wixData.insert('Magiclinks', testLink, { suppressAuth: true });
        console.log('‚úÖ Insert successful:', insertResult._id);

        // Try to query it back
        const queryResult = await wixData.query('Magiclinks')
            .eq('token', testLink.token)
            .find({ suppressAuth: true });

        if (queryResult.items.length > 0) {
            console.log('‚úÖ Query successful: Found', queryResult.items.length, 'item(s)');
        } else {
            console.warn('‚ö†Ô∏è Query returned 0 results (unexpected)');
        }

        // Clean up test data
        await wixData.remove('Magiclinks', insertResult._id, { suppressAuth: true });
        console.log('‚úÖ Cleanup successful');

        return {
            success: true,
            message: 'Magiclinks collection is working correctly',
            testId: insertResult._id
        };

    } catch (error) {
        console.error('‚ùå Magiclinks collection error:', error);
        return {
            success: false,
            error: error.message,
            hint: 'Collection might not exist. Create it in Wix CMS using Magiclinks_Template.csv'
        };
    }
}

/**
 * Test both collections at once
 */
export async function testAllAuthCollections() {
    console.log('üß™ Testing all authentication collections...\n');

    const results = {
        portalSessions: await testPortalSessionsCollection(),
        magiclinks: await testMagiclinksCollection()
    };

    const allPassed = results.portalSessions.success && results.magiclinks.success;

    console.log('\nüìä Test Summary:');
    console.log('Portal Sessions:', results.portalSessions.success ? '‚úÖ PASS' : '‚ùå FAIL');
    console.log('Magiclinks:', results.magiclinks.success ? '‚úÖ PASS' : '‚ùå FAIL');
    console.log('\nOverall:', allPassed ? '‚úÖ ALL TESTS PASSED' : '‚ùå SOME TESTS FAILED');

    return {
        allPassed,
        results
    };
}
