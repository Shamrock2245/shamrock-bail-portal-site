# Shamrock Bail Bonds — Automation Factory Handoff
## Session: Feb 27, 2026 (v2 — Manus Gap-Fill Pass)

> **Picking up from:** Antigravity's commit `94e3ab7` (multi-indemnitor signing pipeline)
> **Status:** All 8 identified gaps patched. Ready for E2E test.

---

## 1. What Was Fixed This Session

### Gap 1 — `Queue.render`: Telegram indemnitor name not displaying
**File:** `Dashboard.html`
**Problem:** `Queue.render` used `item.FullName` only. Telegram items use `item.indemnitorFullName` / `item.indemnitorFirstName` + `item.indemnitorLastName`.
**Fix:** Added fallback chain: `item.FullName || item.indemnitorFullName || firstName + lastName`.

---

### Gap 2 — `Queue.process` Defendant Hydration: Only name was filled
**File:** `Dashboard.html`
**Problem:** When a queue item was processed, only `defendant-first-name` and `defendant-last-name` were set. All other defendant fields (DOB, phone, email, address, city, state, zip, DL, county, facility) were silently dropped.
**Fix:** Extended hydration to map all 10 defendant fields from the `item.*` camelCase keys that Telegram source provides.

---

### Gap 3 — `Queue.process` Indemnitor Hydration: Telegram camelCase fields not read
**File:** `Dashboard.html`
**Problem:** `indemnitorData` was built from `item.FirstName` (Wix PascalCase) and `raw.*` (Wix CMS raw). Telegram items use `item.indemnitorFirstName`, `item.indemnitorAddress`, etc. at the top level — not in `_original`.
**Fix:** Every field now has a 3-tier fallback: `item.PascalCase || item.camelCase || raw.camelCase`.

---

### Gap 4 — `_mapCanonicalToDashboardFormat`: Missing indemnitor fields
**File:** `Telegram_IntakeQueue.js`
**Problem:** The Telegram→Dashboard mapping was missing: `indemnitorMiddleName`, `indemnitorSSN`, `indemnitorDL`, `indemnitorDLState`, `indemnitorEmployerPhone`, `indemnitorEmployerCity`, `indemnitorEmployerState`, `indemnitorSupervisorName`, `indemnitorSupervisorPhone`.
**Fix:** All 9 missing fields added, mapped from canonical `data.Ind*` keys.

---

### Gap 5 — `buildPacketManifest`: Always generated ALL docs regardless of checklist
**File:** `Telegram_Documents.js`
**Problem:** `buildPacketManifest` iterated all `DOC_ORDER` docs unconditionally. Staff checking/unchecking the document checklist had no effect on what was sent to SignNow.
**Fix:** Added `selectedSet` filter. If `caseData.selectedDocIds` is provided (non-empty array), only those doc IDs are included in the manifest.

---

### Gap 6 — `manifestData` in Dashboard: `selectedDocIds` not passed to GAS
**File:** `Dashboard.html`
**Problem:** `generateAndSendWithWixPortal()` built `manifestData` without `selectedDocIds`, so the backend always received all docs.
**Fix:** Added `selectedDocIds` field — reads all checked `[data-template]` checkboxes from the doc checklist at click time.

---

### Gap 7 — `WebhookHandler.js`: `DocSigningTracker` never updated on signing completion
**File:** `WebhookHandler.js`
**Problem:** `handleDocumentComplete` called `logCompletion` and `triggerPostSigningFromWebhook` but never called `updateDocSigningStatus_`. The `DocSigningTracker` sheet stayed at `'created'` forever even after signing.
**Fix:** Added tracker update block after `logCompletion`. Parses the `Shamrock_<docId>[_signer<N>]_<caseNumber>` document name to extract `caseKey` and `trackerKey`, then calls `updateDocSigningStatus_(caseKey, trackerKey, 'signed')`.

---

### Gap 8 — `extractDefendantName`: Didn't understand `Shamrock_` naming convention
**File:** `WebhookHandler.js`
**Problem:** `extractDefendantName` only matched legacy `Bail_Packet_*` / `Bond_*` patterns. New documents are named `Shamrock_<docId>_signer<N>_<caseNumber>` — the function returned just `"Shamrock"` as the name.
**Fix:** Added primary pattern `/^Shamrock_[^_]+(?:_signer-?\d+)?_(.+)$/` that extracts the case number as the identifier. Legacy patterns remain as fallback.

---

## 2. What Still Needs Testing

### Priority 1 — E2E Signing Test (30 min, CRITICAL)
1. Open Dashboard → fill defendant info + add 1–2 indemnitors
2. Check specific docs in the checklist (e.g., uncheck FAQ docs)
3. Click "Generate & Send" → verify only checked docs appear in manifest
4. Verify signing links appear grouped by signer name
5. Complete signing in SignNow → verify `DocSigningTracker` row updates to `'signed'`

### Priority 2 — IntakeQueue Round-Trip
1. Submit indemnitor form on Wix site → verify record appears in Dashboard queue
2. Click "Process" on a Telegram intake (TG- prefix) → verify ALL fields hydrate (not just name)
3. Click "Process" on a Wix intake → verify indemnitor fields hydrate from `_original`
4. Click "Done" → verify record disappears from queue

### Priority 3 — 0-Indemnitor Edge Case
- Generate packet with no indemnitors → verify only defendant-only docs are included
- Confirm `indemnitors.length === 0` placeholder in `buildPacketManifest` still works

### Priority 4 — Template Field Pre-Fill
`handleTelegramGetSigningUrl` calls `prefillDocument_()` — **this function does not exist yet**.
The signing flow will still work (SignNow creates the doc copy and returns a link) but fields won't be pre-filled.
This is the next major build item.

---

## 3. Files Changed This Session

| File | Change |
|------|--------|
| `Dashboard.html` | +~50 lines: defendant hydration (10 fields), indemnitor hydration (3-tier fallback), `selectedDocIds` in manifestData, Queue.render indemnitor display |
| `Telegram_Documents.js` | +8 lines: `selectedSet` filter in `buildPacketManifest` |
| `Telegram_IntakeQueue.js` | +10 lines: 9 missing indemnitor fields in `_mapCanonicalToDashboardFormat` |
| `WebhookHandler.js` | +25 lines: `DocSigningTracker` update on completion, `extractDefendantName` Shamrock_ pattern |

---

## 4. Automation Definition of Done — Current Status

| Requirement | Status |
|-------------|--------|
| Booking → Defendant tab: automated | ✅ Existing (scraper/AI path) |
| IntakeQueue → Indemnitor fields: automated | ✅ Fixed (both Wix + Telegram sources) |
| Dashboard convergence: zero re-entry | ✅ All fields hydrate on queue process |
| Packet generation: one click | ✅ Existing + selectedDocIds filter added |
| Signing + payment: mobile, instant | ✅ Existing (SignNow embedded links) |
| Post-sign ID upload captured + stored | ✅ Existing (Wix webhook → Drive) |
| DocSigningTracker updates on completion | ✅ Fixed (webhook now calls updateDocSigningStatus_) |
| Template pre-fill (data in SignNow fields) | ⚠️ `prefillDocument_()` not yet implemented |

---

## 5. Next Build Item: `prefillDocument_()`

This is the only remaining gap before the factory is truly zero-re-entry.

**What it needs to do:**
1. Accept `(documentId, formData, signerRole)` 
2. Map `formData` fields → SignNow field names (per template)
3. Call `SN_addFields(documentId, fields)` to pre-fill text fields
4. Called from `handleTelegramGetSigningUrl` after `SN_copyTemplate`

**Field mapping needed per doc:**
- Defendant name, DOB, address, DL, phone
- Bond amount, case number, power number, county
- Indemnitor name, address, SSN, DOB, employer (for Indemnity Agreement / SSA)

---

> *"Wire it. Verify it. Ship it."*
> **— Manus, Feb 27, 2026**
